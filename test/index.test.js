import {hexToU8, u8toHex} from 'cbor2/utils';
import {parseEDN, registerAppString} from '../lib/index.js';
import assert from 'node:assert/strict';
// eslint-disable-next-line n/no-unsupported-features/node-builtins
import test from 'node:test';
import {format} from '@fast-csv/format';
const stream = format();
stream.pipe(process.stdout);
const TE = new TextEncoder();

test('index', () => {
  for (const [str, expected] of [
    ['1', '01'],
    ['/ A zero! / 0', '00'],
    ['# A zero!\n0', '00'],
    ['{}', 'a0'],
    ['false', 'f4'],
    ['true', 'f5'],
    ['null', 'f6'],
    ['undefined', 'f7'],
    ['{"a": true, "b": false}', 'a26161f56162f4'],
    ['{1: 0, 2: 1, 3: 2}', 'a3010002010302'],
    ["2(h'02')", 'c24102'],
    ['simple(0)', 'e0'],
    ['simple(20)', 'f4'],
    ['[]', '80'],
    ['[ ]', '80'],
    ['[0]', '8100'],
    ['[0, 1]', '820001'],
    ['[0, 1, 2,]', '83000102'],
    ['[0, 1, 2, ]', '83000102'],
    ['[0 1 2]', '83000102'],
    ['"foo"', '63666f6f'],
    ['"foo\\"\\b\\f\\r\\n\\t\\\\\\/"', '6b666f6f22080c0d0a095c2f'],
    ['"E\\u0308"', '6345cc88'],
    ['"E\\u{0308}"', '6345cc88'],
    ['"E\\u{308}"', '6345cc88'],
    ['"\u{1F4A9}"', '64f09f92a9'],
    ['"\\u{1F4A9}"', '64f09f92a9'],
    ['"\\u{01F4A9}"', '64f09f92a9'],
    ['"\\u{001F4A9}"', '64f09f92a9'],
    ['"\\u{0001F4A9}"', '64f09f92a9'],
    ['"\\u{000061}"', '6161'],
    ['"\\u{10ffff}"', '64f48fbfbf'],
    ['"\\u{10fff}"', '64f090bfbf'],
    ['"\\u{9000}"', '63e98080'],
    ['"\\u{a000}"', '63ea8080'],
    ['"\\u{d000}"', '63ed8080'],
    ['"\\u{d00}"', '63e0b480'],
    ['"\\uD83D\\uDCA9"', '64f09f92a9'],
    ['"foo" + "bar"', '66666f6f626172'],
    ["\t'foo'", '43666f6f'],
    [" 'foo' + 'bar'", '46666f6f626172'],
    ['"\'"', '6127'],
    ["h''", '40'],
    ["h'02'", '4102'],
    ["h'# foo\n02'", '4102'],
    ["h'# foo\\'\"\n02'", '4102'],
    ["h'/ foo / 02'", '4102'],
    ["h'/ foo \\'\" / 02'", '4102'],
    ["h'/ foo \\/\\b / /bar/ 02'", '4102'],
    ["b64'AgM='", '420203'],
    ["b64' _w'", '41ff'],
    ["b64'#foo\n   Zm9vCg=='", '44666f6f0a'],
    ["b64'#foo\n#bar\n  Zm9v  # \\'\"'", '43666f6f'],
    [`\
98([<< {/alg/ 1: -7 /ECDSA 256/} >>, # == h'a10126'
    ...                              # rest elided here
])`, 'd8628243a10126d90378f6'],
    ["zzz'fo\\to'", 'd903e782637a7a7a64666f096f'],
    ['""_', '7fff'],
    ['(_ "foo")', '7f63666f6fff'],
    ['(_ "foo" "bar")', '7f63666f6f63626172ff'],
    ['(_ "foo" "bar" "baz")', '7f63666f6f636261726362617aff'],
    ['256_3(1_2)', 'db00000000000001001a00000001'],
    ['256_2(-1.125_2)', 'da00000100fabf900000'],
    ['255_1(-1_i)', 'd900ff20'],
    ['[_]', '9fff'],
    ['[_ 1, 2]', '9f0102ff'],
    ['[_i 1, 2]', '820102'],
    ['[_0 1, 2]', '98020102'],
    ['[_1 1, 2]', '9900020102'],
    ['[_2 1, 2]', '9a000000020102'],
    ['[_3 1, 2]', '9b00000000000000020102'],
    ['{_ }', 'bfff'],
    ['{_ 1: 2}', 'bf0102ff'],
    ['{_i "a": 1, "b": 2}', 'a2616101616202'],
    ['{_0 "a": 1, "b": 2}', 'b802616101616202'],
    ['{_1 "a": 1, "b": 2}', 'b90002616101616202'],
    ['{_2 "a": 1, "b": 2}', 'ba00000002616101616202'],
    ['{_3 "a": 1, "b": 2}', 'bb0000000000000002616101616202'],
    ['"foo"_i', '63666f6f'],
    ['...', 'd90378f6'],
    ['"foo" + ...', 'd903788263666f6fd90378f6'],
    ['... + "foo"', 'd9037882d90378f663666f6f'],
    ['... + << "foo" >>', 'd9037882d90378f64463666f6f'],
    ["... + zzz'foo'", 'd9037882d90378f6d903e782637a7a7a63666f6f'],
    ["... + ip'192.168.1.2'", 'd9037882d90378f644c0a80102'],
    ["ip'250.200.100.10'", '44fac8640a'],
    ["ip'192.168.1.2/13'", '820d42c0a0'],
    ["ip'::192.168.1.2'", '50000000000000000000000000c0a80102'],
    ["IP'::192.168.1.2'", 'd83650000000000000000000000000c0a80102'],
    ["ip'2008::1:2'", '5020080000000000000000000000010002'],
    ["ip'2001:0db8:85a3:0000:0000:8a2e:0370:7334'", '5020010db885a3000000008a2e03707334'],
    ["ip'::0db8:85a3:0000:0000:8a2e:0370:7334'", '5000000db885a3000000008a2e03707334'],
    ["ip'2001::85a3:0000:0000:8a2e:0370:7334'", '502001000085a3000000008a2e03707334'],
    ["ip'::85a3:0000:0000:8a2e:0370:7334'", '500000000085a3000000008a2e03707334'],
    ["ip'2001::0000:0000:8a2e:0370:7334'", '50200100000000000000008a2e03707334'],
    ["ip'2001:0db8::0000:0000:8a2e:0370:7334'", '5020010db80000000000008a2e03707334'],
    ["ip'2001:0db8:85a3::0000:8a2e:0370:7334'", '5020010db885a3000000008a2e03707334'],
    ["ip'2001:0db8::0000:0000:8a2e:0370:7334'", '5020010db80000000000008a2e03707334'],
    ["ip'2001::0000:0000:8a2e:0370:7334'", '50200100000000000000008a2e03707334'],
    ["ip'1:2:3:4:5:6:7:8'", '5000010002000300040005000600070008'],
    ["ip'::2:3:4:5:6:7:8'", '5000000002000300040005000600070008'],
    ["ip'1::3:4:5:6:7:8'", '5000010000000300040005000600070008'],
    ["ip'1:2::4:5:6:7:8'", '5000010002000000040005000600070008'],
    ["ip'1:2:3::5:6:7:8'", '5000010002000300000005000600070008'],
    ["ip'1:2:3:4::6:7:8'", '5000010002000300040000000600070008'],
    ["ip'1:2:3:4:5::7:8'", '5000010002000300040005000000070008'],
    ["ip'1:2:3:4:5:6::8'", '5000010002000300040005000600000008'],
    ["ip'1:2:3:4:5:6:7::'", '5000010002000300040005000600070000'],
    ["ip'::3:4:5:6:7:8'", '5000000000000300040005000600070008'],
    ["ip'1::4:5:6:7:8'", '5000010000000000040005000600070008'],
    ["ip'1:2::5:6:7:8'", '5000010002000000000005000600070008'],
    ["ip'1:2:3::6:7:8'", '5000010002000300000000000600070008'],
    ["ip'1:2:3:4::7:8'", '5000010002000300040000000000070008'],
    ["ip'1:2:3:4:5::8'", '5000010002000300040005000000000008'],
    ["ip'1:2:3:4:5:6::'", '5000010002000300040005000600000000'],
    ["ip'::4:5:6:7:8'", '5000000000000000040005000600070008'],
    ["ip'1::5:6:7:8'", '5000010000000000000005000600070008'],
    ["ip'1:2::6:7:8'", '5000010002000000000000000600070008'],
    ["ip'1:2:3::7:8'", '5000010002000300000000000000070008'],
    ["ip'1:2:3:4::8'", '5000010002000300040000000000000008'],
    ["ip'1:2:3:4:5::'", '5000010002000300040005000000000000'],
    ["ip'::5:6:7:8'", '5000000000000000000005000600070008'],
    ["ip'1::6:7:8'", '5000010000000000000000000600070008'],
    ["ip'1:2::7:8'", '5000010002000000000000000000070008'],
    ["ip'1:2:3::8'", '5000010002000300000000000000000008'],
    ["ip'1:2:3:4::'", '5000010002000300040000000000000000'],
    ["ip'::6:7:8'", '5000000000000000000000000600070008'],
    ["ip'1::7:8'", '5000010000000000000000000000070008'],
    ["ip'1:2::8'", '5000010002000000000000000000000008'],
    ["ip'1:2:3::'", '5000010002000300000000000000000000'],
    ["ip'::7:8'", '5000000000000000000000000000070008'],
    ["ip'1::8'", '5000010000000000000000000000000008'],
    ["ip'1:2::'", '5000010002000000000000000000000000'],
    ["ip'::8'", '5000000000000000000000000000000008'],
    ["ip'1::'", '5000010000000000000000000000000000'],
    ["ip'::1'", '5000000000000000000000000000000001'],
    ["ip'::'", '5000000000000000000000000000000000'],

    ["dt'2024-08-25T14:13:55-06:00'", '1a66cb9083'],
    ["dt'2024-08-25T14:13:55Z'", '1a66cb3c23'],
    ["DT'2024-08-25T14:13:55-06:00'", 'c11a66cb9083'],
    ["DT'2024-08-25T14:13:55Z'", 'c11a66cb3c23'],

    ["dt'2024-08-25T14:13:55.1-06:00'", 'fb41d9b2e420c66666'],
    ["dt'2024-08-25T14:13:55.1Z'", 'fb41d9b2cf08c66666'],
    ["DT'2024-08-25T14:13:55.1-06:00'", 'c1fb41d9b2e420c66666'],
    ["DT'2024-08-25T14:13:55.1Z'", 'c1fb41d9b2cf08c66666'],

    ["b32'MZXW6==='", '43666f6f'],
    ["h32'CPNMU==='", '43666f6f'],
    ['18014398509481984', '1b0040000000000000'],
    ['\t/ \\t / 0', '00'],
  ]) {
    try {
      // stream.write(['x', str, expected]);
      const bytes = parseEDN(str);
      assert.deepEqual(
        bytes,
        hexToU8(expected),
        `${str} => ${u8toHex(bytes)} != ${expected}`
      );
    } catch (e) {
      // eslint-disable-next-line no-console
      console.log('ERROR', expected);
      throw e;
    }
  }
});

test('failures', () => {
  for (const invalid of [
    // Only things that would require WTF-8 to store in CSV
    '/ foo\uD83D /',
    '#\uD83D',
    '"\uDCA9"',
    '"\uD83D"',
    '"\\uDCA9"',
    '"\\uD83D"',
    '"\\uD83D\\"',
    '"\\uD83D\\u"',
    '"\\uD83D\\uDD0"',
    '"\\uD83D\\uD000"',
    '"\\ud9000"',
    '"\\ud90"',
  ]) {
    //
    // stream.write(['-', `h]${u8toHex(TE.encode(invalid))}`, '']);
    // stream.write(['-', invalid, '']);
    assert.throws(() => parseEDN(invalid), invalid);
  }
  stream.end('\n\n');
});

test('registerAppString', () => {
  // Before registration, 999(["rot13", "foo"])
  assert.equal(u8toHex(parseEDN("rot13'foo'")), 'd903e78265726f74313363666f6f');
  const orig = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
  const rot = 'NOPQRSTUVWXYZABCDEFGHIJKLMnopqrstuvwxyzabcdefghijklm';

  registerAppString(
    'rot13',
    (_prefix, str) => [
      null,
      str.replace(/[a-z]/gi, c => rot[orig.indexOf(c)]),
    ]
  );

  // After registration, rotated string
  assert.equal(u8toHex(parseEDN("rot13'foo'")), '63736262');
  assert.equal(u8toHex(parseEDN("rot13'sbb'")), '63666f6f');

  // Back to original
  registerAppString('rot13');
  assert.equal(u8toHex(parseEDN("rot13'foo'")), 'd903e78265726f74313363666f6f');

  // Invalid rule
  registerAppString('iiii', () => ['__InVaLid__']);
  assert.throws(() => parseEDN("iiii''"), /Invalid start rule/);
});
